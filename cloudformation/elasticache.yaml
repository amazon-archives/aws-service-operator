AWSTemplateFormatVersion: "2010-09-09"
Description: 'AWS Operator - Amazon Elasticache Cluster'
Parameters:
  Namespace:
    Description: >-
      This is the namespace for the Kubernetes object.
    Type: String
  ResourceVersion:
    Type: String
    Description: >-
      This is the resource version for the Kubernetes object.
  ResourceName:
    Description: >-
      This is the resource name for the Kubernetes object
    Type: String
  AutoMinorVersionUpgrade:
    Description: >-
      Indicates that minor engine upgrades will be applied automatically to the cache cluster during the maintenance window.
    Type: String
    Default: false
  CacheNodeType:
    Description: >-
      The compute and memory capacity of nodes in a cache cluster.
      https://docs.aws.amazon.com/AmazonElastiCache/latest/mem-ug/CacheNodes.SupportedTypes.html
    Type: String
    Default: cache.m5.large
  CacheParameterGroupName:
    Description: >-
      The name of the cache parameter group that is associated with this cache cluster.
    Type: String
  CacheSubnetGroupName:
    Description: >-
      The cache subnet group that you associate with a cache cluster. 
      "Required: Conditional. If you specified the VpcSecurityGroupIds property, you must specify this property."
    Type: String
  ClusterName:
    Description: >-
      This is the cluster name for the operator
    Type: String
  Engine:
    Description: >-
      The name of the cache engine to be used for this cache cluster, such as memcached or redis.
    Type: String
    Default: "redis"
  EngineVersion:
    Description: >-
      The version of the cache engine to be used for this cluster.
    Type: String
    Default: "5.0.0"
  NotificationTopicArn:
    Description: >-
      The Amazon Resource Name (ARN) of the Amazon Simple Notification Service (SNS) topic to which notifications will be sent.
    Type: String
  NumCacheNodes:
    Description: >-
      The number of cache nodes that the cache cluster should have.
    Type: Number
    Default: "1"
  Port:
    Description: >-
      The port number on which each of the cache nodes will accept connections.
    Type: Number
  PreferredMaintenanceWindow:
    Description: >-
      The weekly time range (in UTC) during which system maintenance can occur.
    Type: String
    Default: mon:05:00-mon:09:00
  SnapshotWindow:
    Description: >-
      For Redis cache clusters, the daily time range (in UTC) during which ElastiCache will begin taking a daily snapshot of your node group. For example, you can specify 05:00-09:00.
    Type: String
    Default: "05:00-09:00"
  VpcSecurityGroupIds:
    Description: >-
      A list of VPC security group IDs. If your cache cluster isn't in a VPC, specify the CacheSecurityGroupNames property instead.
    Type: List<AWS::EC2::SecurityGroup::Id>
Resources:
  ElastiCacheCluster:
    Type: AWS::ElastiCache::CacheCluster
    Properties: 
      AutoMinorVersionUpgrade: !Ref AutoMinorVersionUpgrade
      CacheNodeType: !Ref CacheNodeType
      CacheParameterGroupName: !Ref CacheParameterGroupName
      CacheSubnetGroupName: !Ref CacheSubnetGroupName
      ClusterName: !Ref ClusterName
      Engine: !Ref Engine
      EngineVersion: !Ref EngineVersion
      NumCacheNodes: !Ref NumCacheNodes
      Port: !Ref Port
      PreferredMaintenanceWindow: !Ref PreferredMaintenanceWindow
      SnapshotWindow: !Ref SnapshotWindow
      Tags:
        - Key: Namespace
          Value: !Ref Namespace
        - Key: ResourceVersion
          Value: !Ref ResourceVersion
        - Key: ResourceName
          Value: !Ref ResourceName
        - Key: ClusterName
          Value: !Ref ClusterName
        - Key: Heritage
          Value: operator.aws
      VpcSecurityGroupIds: !Ref VpcSecurityGroupIds
Outputs:
  RedisEndpointAddress:
    Value: !GetAtt
      - ElastiCacheCluster
      - RedisEndpoint.Address
    Description: The DNS address of the configuration endpoint for the Redis cache cluster.
  RedisEndpointPort:
    Value: !GetAtt 
      - ElastiCacheCluster
      - RedisEndpoint.Port
    Description: The port number of the configuration endpoint for the Redis cache cluster.
